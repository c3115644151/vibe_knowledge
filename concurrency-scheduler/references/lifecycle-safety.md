# ç”Ÿå‘½å‘¨æœŸå®‰å…¨æŒ‡å— (Lifecycle Safety Guide)

> **å‰è¨€**: å¾ˆå¤šæ’ä»¶åœ¨å¼€å‘ç¯å¢ƒä¸‹è¿è¡Œå®Œç¾ï¼Œä½†ä¸€éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œç»å†å‡ æ¬¡é‡å¯æˆ–å´©æºƒåï¼Œå°±ä¼šå‡ºç°ï¼š
> 1.  **å¹½çµå®ä½“**: æ— æ³•äº¤äº’çš„æµ®ç©ºæ–‡å­—æˆ–ç‰©å“ã€‚
> 2.  **æ•°æ®ä¸¢å¤±**: æœºå™¨é‡Œçš„ç‰©å“è¢«â€œæ´—åŠ«ä¸€ç©ºâ€ã€‚
> 3.  **åŠŸèƒ½å¤±æ•ˆ**: æœºå™¨è¿˜åœ¨ï¼Œä½†å³é”®æ²¡ååº”ï¼ˆå¼•ç”¨å¤±æ•ˆï¼‰ã€‚
>
> æœ¬æŒ‡å—æä¾›ä¸€å¥—æ ‡å‡†åŒ–çš„é˜²å¾¡ç­–ç•¥ï¼Œç¡®ä¿ä½ çš„æ’ä»¶åœ¨ä»»ä½•æç«¯æƒ…å†µä¸‹éƒ½èƒ½æ•°æ®å®‰å…¨ã€é€»è¾‘è‡ªæ´½ã€‚

## 1. æ ¸å¿ƒå“²å­¦ï¼šæ•°æ®æºçœŸç† (Source of Truth)

**é»„é‡‘æ³•åˆ™**: **æ°¸è¿œä¸è¦ä¿¡ä»»ä¸–ç•Œé‡Œçš„å®ä½“ (Entity) æˆ–æ–¹å— (BlockState)ï¼Œåªä¿¡ä»»ä½ çš„æ•°æ® (Data)ã€‚**

*   **ä¸–ç•Œé‡Œçš„å®ä½“**æ˜¯æš‚æ—¶çš„ã€ä¸ç¨³å®šçš„ã€éšæ—¶å¯èƒ½è¢« `/kill` æˆ–åŒºå—å¸è½½æ¸…é™¤çš„ã€‚
*   **ä½ çš„æ•°æ®**ï¼ˆå­˜å‚¨åœ¨ PDCã€YAML æˆ–æ•°æ®åº“ä¸­ï¼‰æ‰æ˜¯æ°¸æ’çš„ã€‚
*   **è§†è§‰æ•ˆæœ**åªæ˜¯æ•°æ®çš„æŠ•å½±ã€‚æœåŠ¡å™¨é‡å¯åï¼Œåº”è¯¥æ ¹æ®æ•°æ®**é‡å»º**è§†è§‰ï¼Œè€Œä¸æ˜¯è¯•å›¾**ä¿å­˜**è§†è§‰ã€‚

---

## 2. åœºæ™¯ä¸€ï¼šæœºå™¨åŠŸèƒ½å¤±æ•ˆ (The Stale Reference)

**ç—‡çŠ¶**: æœåŠ¡å™¨é‡å¯åï¼Œæœºå™¨å¤–è§‚æ­£å¸¸ï¼Œä½†å³é”®äº¤äº’æ— ååº”ï¼Œæˆ–è€…åå°é€»è¾‘æŠ¥é”™ã€‚
**æˆå› **: æ’ä»¶æŒæœ‰äº†æ—§çš„ `Block`ã€`Inventory` æˆ– `TileEntity` å¯¹è±¡å¼•ç”¨ã€‚é‡å¯åï¼ŒBukkit åˆ›å»ºäº†æ–°çš„å¯¹è±¡ï¼Œæ—§å¼•ç”¨æŒ‡å‘äº†è™šç©ºã€‚

### âœ… è§£å†³æ–¹æ¡ˆï¼šåŠ¨æ€è·å–æˆ–å»¶è¿Ÿç»‘å®š

#### A. å¼ºåˆ¶å¿«ç…§æ¨¡å¼ (æ¨è)
ä¸æŒæœ‰å¼•ç”¨ï¼Œæ¯æ¬¡äº¤äº’æ—¶ä»ä¸–ç•Œè·å–ã€‚
```java
// âŒ é”™è¯¯ï¼šåœ¨æ„é€ å‡½æ•°é‡Œå­˜äº† Inventory
private Inventory inv; 

// âœ… æ­£ç¡®ï¼šæ¯æ¬¡ç”¨çš„æ—¶å€™æ‹¿
public void tick() {
    if (location.getBlock().getState() instanceof Container c) {
        process(c.getInventory());
    }
}
```

#### B. æŒä¹…å¼•ç”¨æ¨¡å¼çš„é‡è½½ä¿æŠ¤
å¦‚æœä½ å¿…é¡»æŒæœ‰å¼•ç”¨ï¼ˆä¸ºäº†æ€§èƒ½ï¼‰ï¼Œå¿…é¡»ç›‘å¬ `ChunkLoadEvent` æ¥æ›´æ–°å¼•ç”¨ã€‚
```java
public class Machine {
    private Inventory cachedInv;
    
    // å½“åŒºå—é‡æ–°åŠ è½½æ—¶ï¼Œå¿…é¡»åˆ·æ–°å¼•ç”¨ï¼
    public void onChunkLoad() {
        if (location.getBlock().getState() instanceof Container c) {
            this.cachedInv = c.getInventory();
        }
    }
}
```

---

## 3. åœºæ™¯äºŒï¼šæ•°æ®ä¸¢å¤±/ç‰©å“è¢«æ´—åŠ« (Data Loss)

**ç—‡çŠ¶**: ç©å®¶åœ¨æœºå™¨é‡Œæ”¾äº†é’»çŸ³ï¼Œé‡å¯åé’»çŸ³æ²¡äº†ã€‚
**æˆå› **: æ•°æ®ä¿®æ”¹åªå‘ç”Ÿåœ¨å†…å­˜ä¸­ï¼Œæ²¡æœ‰å†™å…¥ç£ç›˜ (PDC/NBT)ï¼Œæˆ–è€…åœ¨ `onDisable` æ—¶ä¿å­˜å¤±è´¥ã€‚

### âœ… è§£å†³æ–¹æ¡ˆï¼šäº‹åŠ¡æ€§ä¿å­˜ (Transactional Saving)

**åŸåˆ™**: **é‡è¦æ•°æ®ï¼ˆå¦‚ç‰©å“ï¼‰ä¸è¦ç­‰å¾…å…³æœæ‰ä¿å­˜ï¼Œä¿®æ”¹å³ä¿å­˜ã€‚**

```java
public void setInputItem(ItemStack item) {
    // 1. ä¿®æ”¹å†…å­˜/ç•Œé¢
    this.inventory.setItem(0, item);
    
    // 2. ğŸš¨ ç«‹å³æŒä¹…åŒ– (ä¸è¦ç­‰ onDisable!)
    // å¦‚æœæ˜¯ BlockState æ¨¡å¼ï¼š
    BlockState state = location.getBlock().getState();
    if (state instanceof Container c) {
        c.getInventory().setItem(0, item);
        c.update(true); // å¼ºåˆ¶å†™å…¥ç£ç›˜
    }
    
    // å¦‚æœæ˜¯è‡ªå®šä¹‰æ•°æ®æ¨¡å¼ï¼š
    saveToDisk();
}
```

**å¯¹äºé«˜é¢‘æ•°æ®ï¼ˆå¦‚è¿›åº¦æ¡ï¼‰**: å¯ä»¥åªåœ¨å†…å­˜æ›´æ–°ï¼Œä½†å¿…é¡»åœ¨ `ChunkUnloadEvent` å’Œ `onDisable` ä¸­å¼ºåˆ¶ä¿å­˜ã€‚

```java
@EventHandler
public void onChunkUnload(ChunkUnloadEvent event) {
    // æŸ¥æ‰¾è¯¥åŒºå—å†…çš„æ‰€æœ‰æœºå™¨ï¼Œå¼ºåˆ¶ä¿å­˜æ•°æ®
    plugin.getMachineManager().saveAllInChunk(event.getChunk());
}
```

---

## 4. åœºæ™¯ä¸‰ï¼šå¹½çµå®ä½“ (Ghost Entities)

**ç—‡çŠ¶**: é‡å¯åï¼ŒåŸæ¥çš„æµ®ç©ºæ–‡å­—/ç‰©å“è¿˜åœ¨ï¼Œä½†æ— æ³•äº¤äº’ã€‚æ’ä»¶åˆç”Ÿæˆäº†ä¸€å¥—æ–°çš„ï¼Œå¯¼è‡´é‡å ã€‚æˆ–è€…æœåŠ¡å™¨å´©æºƒåï¼Œå®ä½“æ®‹ç•™ã€‚
**æˆå› **: æ’ä»¶ä¾èµ– `onDisable` æ¸…ç†å®ä½“ï¼Œä½†æœåŠ¡å™¨å´©æºƒæ—¶ `onDisable` ä¸ä¼šæ‰§è¡Œã€‚

### âœ… è§£å†³æ–¹æ¡ˆï¼šå¼€æœºè‡ªæ£€ä¸å¹‚ç­‰æ€§ (Idempotency)

**ç­–ç•¥**: å‡è®¾ä¸Šæ¬¡æœåŠ¡å™¨æ˜¯å´©æºƒçš„ã€‚å¯åŠ¨æ—¶å…ˆ**æ¸…ç†**æˆ˜åœºï¼Œå†**é‡å»º**ã€‚

#### æ­¥éª¤ 1: æ ‡è®°ä½ çš„å®ä½“
åˆ›å»ºå®ä½“æ—¶ï¼ŒåŠ¡å¿…æ‰“ä¸Šæ ‡ç­¾ (Tag) å’ŒæŒä¹…åŒ– (Persistent)ã€‚
```java
ItemDisplay display = world.spawn(loc, ItemDisplay.class);
display.addScoreboardTag("my_plugin_entity"); // å…³é”®ï¼
display.setPersistent(true); // é˜²æ­¢åŒºå—å¸è½½æ—¶æ¶ˆå¤±
```

#### æ­¥éª¤ 2: åŠ è½½æ—¶å…ˆæ¸…ç† (Sanity Check)
åœ¨ç”Ÿæˆæ–°å®ä½“ä¹‹å‰ï¼Œå…ˆæ‰«æå‘¨å›´ï¼ŒæŠŠæ—§çš„ï¼ˆå¯èƒ½æ˜¯å°¸ä½“ï¼‰æ¸…ç†æ‰ã€‚

```java
public void spawnVisuals(Location loc) {
    // 1. ğŸ§¹ æ‰«åœ°åƒ§æ¨¡å¼ï¼šå…ˆæ¸…ç†è¯¥ä½ç½® 1æ ¼å†…çš„æ‰€æœ‰æ—§å®ä½“
    for (Entity e : loc.getWorld().getNearbyEntities(loc, 1, 1, 1)) {
        if (e.getScoreboardTags().contains("my_plugin_entity")) {
            e.remove(); // æ€æ‰æ—§çš„/å¹½çµå®ä½“
        }
    }
    
    // 2. âœ¨ åˆ›å»ºæ–°çš„
    createDisplayEntity(loc);
}
```

#### æ­¥éª¤ 3: å»¶è¿ŸåŠ è½½ (ChunkLoad Delay)
åœ¨ `ChunkLoadEvent` ä¸­ï¼Œå®ä½“åŠ è½½å¾€å¾€æ¯”æ–¹å—æ™š 1 tickã€‚å¦‚æœç«‹å³æ¸…ç†ï¼Œå¯èƒ½æ‰¾ä¸åˆ°å®ä½“ï¼Œå¯¼è‡´æ¸…ç†å¤±è´¥ã€‚

```java
@EventHandler
public void onChunkLoad(ChunkLoadEvent event) {
    // å»¶è¿Ÿ 1 tick æ‰§è¡Œæ¸…ç†å’Œé‡å»º
    Bukkit.getScheduler().runTaskLater(plugin, () -> {
        if (!event.getChunk().isLoaded()) return;
        manager.restoreVisuals(event.getChunk());
    }, 1L);
}
```

## 5. æ€»ç»“æ¸…å• (Checklist)

1.  [ ] **å¼•ç”¨å®‰å…¨**: æ˜¯å¦åœ¨ `ChunkLoad` æ—¶åˆ·æ–°äº† `Inventory`/`BlockState` å¼•ç”¨ï¼Ÿ
2.  [ ] **æ•°æ®å®‰å…¨**: ç‰©å“å˜åŠ¨æ˜¯å¦ç«‹å³è§¦å‘äº† `update(true)` æˆ– PDC ä¿å­˜ï¼Ÿ
3.  [ ] **å¸è½½ä¿æŠ¤**: æ˜¯å¦ç›‘å¬äº† `ChunkUnload` å¹¶ä¿å­˜äº†å‰©ä½™æ•°æ®ï¼Ÿ
4.  [ ] **å¹½çµé˜²å¾¡**: ç”Ÿæˆå®ä½“å‰ï¼Œæ˜¯å¦å…ˆæ‰§è¡Œäº† `remove()` æ¸…ç†æ—§å®ä½“ï¼Ÿ
5.  [ ] **å´©æºƒå…¼å®¹**: ä»£ç æ˜¯å¦å‡è®¾ `onDisable` å¯èƒ½æ ¹æœ¬ä¸ä¼šæ‰§è¡Œï¼Ÿ

éµå¾ªä»¥ä¸Šè§„èŒƒï¼Œä½ çš„æ’ä»¶å°†æ‹¥æœ‰**å·¥ä¸šçº§**çš„ç¨³å®šæ€§ï¼Œæ— æƒ§å´©æºƒä¸é‡å¯ã€‚
